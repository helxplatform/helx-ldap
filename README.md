# HElX LDAP Repository

## Overview
This repository, named **helx-ldap**, contains scripts and configuration files for 
deploying **OpenLDAP** as part of a Kubernetes infrastructure. The deployment 
focuses on handling per-user specialization within Kubernetes clusters, storing 
user information in LDAP for managing access and resource provisioning. The 
repository also includes tools for automating the generation of configuration 
files necessary for the deployment and setup of OpenLDAP.

## Contents
- Python scripts for automating the generation of configuration and Helm values
  files.
- Example configuration files that can be customized and deployed.
- Makefile for automating tasks such as generating configuration files and 
  deploying LDAP.

## Configuration Files and Scripts

### `helx_ldap_config.yaml`
The **`helx_ldap_config.yaml`** file is generated using the Python script 
`generate_helx_ldap_config.py`. It stores important LDAP-related configurations, 
including:
- **LDAP Server URL**: The address of the LDAP server.
- **Admin Bind DN**: The Distinguished Name used by the admin to bind to the 
  LDAP server for performing administrative tasks.
- **Config DN**: The DN used for accessing the `cn=config` tree, where the LDAP 
  server's internal configuration is managed.
- **Admin Password** and **Config Password**: The passwords for the admin and 
  config DNs are securely stored in this file.

This YAML file is central to both the LDAP deployment and for generating other 
necessary configuration files.

### `openldap_values.yaml`
The **`openldap_values.yaml`** file is a Helm values file used to deploy 
OpenLDAP via Helm charts. It specifies settings like:
- **Replica Count**: Number of replicas to run for OpenLDAP.
- **Admin and Config Passwords**: These are fetched from `helx_ldap_config.yaml`
  and inserted into this file for use in the OpenLDAP Helm deployment.
- **Persistence and Replication** settings to manage OpenLDAPâ€™s data storage and 
  redundancy.

This file is generated by the Python script `generate_openldap_values.py` and 
allows the automatic deployment of OpenLDAP using Helm.

### Python Scripts
1. **`generate_helx_ldap_config.py`**: This script prompts the user for LDAP 
   configuration settings, including server URL, admin DN, config DN, and 
   optionally generates random passwords for the admin and config users. The 
   generated settings are stored in the `helx_ldap_config.yaml` file.
   
2. **`generate_openldap_values.py`**: This script reads the LDAP settings from 
   `helx_ldap_config.yaml` and generates the `openldap_values.yaml` Helm values 
   file, used for deploying OpenLDAP via a Helm chart. 

### Makefile
The **Makefile** automates several tasks in this repository, including:
- **`make openldap_values.yaml`**: Generates the Helm values file 
  (`openldap_values.yaml`) using the Python script.
- **`make clean`**: Cleans up generated files such as `helx_ldap_config.yaml` 
  and `openldap_values.yaml`.


## Automating OpenLDAP Deployment Using Helm

To deploy OpenLDAP using Helm and the values file `openldap_values.yaml`, follow 
the steps below. The Helm chart we use is referred to simply as **openldap**, 
though it originates from [Artifact Hub](https://artifacthub.io/packages/helm/helm-openldap/openldap-stack-ha).

### Prerequisites:
- **Helm** installed on your system.
- Access to a Kubernetes cluster with the proper context set.
- The `openldap_values.yaml` file generated using the scripts provided in this 
  repository.

### Steps for Deployment:

1. **Add the OpenLDAP Helm Repository**:
   Add the repository where the Helm chart is hosted:
   ```
   helm repo add openldap https://jp-gouin.github.io/helm-openldap/
   ```

2. **Update the Helm Repository**:
   Ensure you have the latest charts:
   ```
   helm repo update
   ```

3. **Deploy OpenLDAP**:
   Deploy OpenLDAP using the values file you generated:
   ```
   helm install openldap openldap/openldap-stack-ha -f openldap_values.yaml
   ```

4. **Verify the Deployment**:
   After deployment, verify the OpenLDAP pods are running:
   ```
   kubectl get pods
   ```

### Makefile support:
This process is automated by the Makefile targets `helm_repo_add` and
`helm_deploy`
```
make helm_repo_add
make helm_deploy
```

### Accessing OpenLDAP via Port-Forwarding

Once OpenLDAP is deployed in the Kubernetes cluster, you can forward the LDAP 
service port to your local machine to interact with it. By default, OpenLDAP 
uses port **389** for LDAP, but since ports below **1024** require elevated 
permissions, we will forward the service to port **5389** on your local machine.

#### Port-Forwarding the OpenLDAP Service

To forward the LDAP port to **5389** locally, run the following command:

```
kubectl port-forward svc/openldap 5389:389
```

## Generic LDIF-Applying Script

The script `apply_ldif_files.py` allows you to apply multiple LDIF files in a 
specified directory in a **bottom-up** order. This is particularly useful when 
you have dependencies among your LDIF files, such as module loading or schema 
extensions, which need to be applied before the main overlay or configuration.

### Script Overview

The script uses the following steps:

1. **Load LDAP Configuration**: The LDAP configuration (such as server URL, bind 
   DN, and password) is read from the `helx_ldap_config.yaml` file.
   
2. **Directory Traversal**: The script traverses the directory tree rooted at 
   the provided directory in a bottom-up order (applying dependencies first).

3. **Apply LDIF Files**: Each `.ldif` file in the directory tree is applied to 
   the LDAP server using the `ldapmodify` command.

## Enabling the `memberOf` Overlay in OpenLDAP

The **`memberOf`** overlay in OpenLDAP provides automatic management of 
group membership information in user entries. When the overlay is enabled, 
any group membership changes (such as adding a user to a group) will 
automatically reflect in the user's `memberOf` attribute, which lists all 
groups the user is a member of.

This functionality is particularly useful for environments that frequently 
query group membership from the user entries, as it eliminates the need to 
manually track which groups a user belongs to.

## `memberOf` Overlay

To enable the `memberOf` overlay, the following steps are required:

1. **Load the `memberOf` Module**: The `memberof` module must be loaded into 
   the OpenLDAP server to make the overlay available.
   
2. Apply the memberOf Overlay: After the module is loaded, the memberOf overlay
   must be configured for the specific database where user and group entries
   are stored. The overlay ensures that the memberOf attribute is automatically
   maintained for any changes to group membership.

### Makefile support

This is automated using the `apply_memberof` target
```
make apply_memberof
```

## `kubernetesSC` user extension

The user definition (inetOrgUser) has been extended to also include a
Kubernetes SecurityContext and PodSecurityContext indended to modify a
pod on behalf of a user.  This is done with LDIF as well.

### Applying Kubernetes SC LDIFs

In addition to managing the `memberOf` overlay, the repository also includes 
LDIF files related to Kubernetes service account configuration. These LDIF 
files are located in the `ldif/kubernetesSC` directory and can be processed 
using the same generic LDIF-applying script.

### Makefile Support

The `apply_kubernetes_sc` Makefile target automates the process of applying 
these LDIF files. It uses the same generic script (`apply_ldif_files.py`) but 
starts in the `ldif/kubernetesSC` directory.
```
make apply_kubernetes_sc
```
