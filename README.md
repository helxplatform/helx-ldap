# HElX LDAP Repository

## Overview
This repository, named **helx-ldap**, contains scripts and configuration files for 
deploying **OpenLDAP** as part of a Kubernetes infrastructure. The deployment 
focuses on handling per-user specialization within Kubernetes clusters, storing 
user information in LDAP for managing access and resource provisioning. The 
repository also includes tools for automating the generation of configuration 
files necessary for the deployment and setup of OpenLDAP.

## Contents
- Python scripts for automating the generation of configuration and Helm values
  files.
- Example configuration files that can be customized and deployed.
- Makefile for automating tasks such as generating configuration files and 
  deploying LDAP.

## Configuration Files and Scripts

### `helx_ldap_config.yaml`
The **`helx_ldap_config.yaml`** file is generated using the Python script 
`generate_helx_ldap_config.py`. It stores important LDAP-related configurations, 
including:
- **LDAP Server URL**: The address of the LDAP server.
- **Admin Bind DN**: The Distinguished Name used by the admin to bind to the 
  LDAP server for performing administrative tasks.
- **Config DN**: The DN used for accessing the `cn=config` tree, where the LDAP 
  server's internal configuration is managed.
- **Admin Password** and **Config Password**: The passwords for the admin and 
  config DNs are securely stored in this file.

This YAML file is central to both the LDAP deployment and for generating other 
necessary configuration files.

### `openldap_values.yaml`
The **`openldap_values.yaml`** file is a Helm values file used to deploy 
OpenLDAP via Helm charts. It specifies settings like:
- **Replica Count**: Number of replicas to run for OpenLDAP.
- **Admin and Config Passwords**: These are fetched from `helx_ldap_config.yaml`
  and inserted into this file for use in the OpenLDAP Helm deployment.
- **Persistence and Replication** settings to manage OpenLDAPâ€™s data storage and 
  redundancy.

This file is generated by the Python script `generate_openldap_values.py` and 
allows the automatic deployment of OpenLDAP using Helm.

### Python Scripts
1. **`generate_helx_ldap_config.py`**: This script prompts the user for LDAP 
   configuration settings, including server URL, admin DN, config DN, and 
   optionally generates random passwords for the admin and config users. The 
   generated settings are stored in the `helx_ldap_config.yaml` file.
   
2. **`generate_openldap_values.py`**: This script reads the LDAP settings from 
   `helx_ldap_config.yaml` and generates the `openldap_values.yaml` Helm values 
   file, used for deploying OpenLDAP via a Helm chart. 

### Makefile
The **Makefile** automates several tasks in this repository, including:
- **`make openldap_values.yaml`**: Generates the Helm values file 
  (`openldap_values.yaml`) using the Python script.
- **`make clean`**: Cleans up generated files such as `helx_ldap_config.yaml` 
  and `openldap_values.yaml`.


## Automating OpenLDAP Deployment Using Helm

To deploy OpenLDAP using Helm and the values file `openldap_values.yaml`, follow 
the steps below. The Helm chart we use is referred to simply as **openldap**, 
though it originates from [Artifact Hub](https://artifacthub.io/packages/helm/helm-openldap/openldap-stack-ha).

### Prerequisites:
- **Helm** installed on your system.
- Access to a Kubernetes cluster with the proper context set.
- The `openldap_values.yaml` file generated using the scripts provided in this 
  repository.

#### Steps for Deployment:

1. **Add the OpenLDAP Helm Repository**:
   Add the repository where the Helm chart is hosted:
   ```
   helm repo add openldap https://jp-gouin.github.io/helm-openldap/
   ```

2. **Update the Helm Repository**:
   Ensure you have the latest charts:
   ```
   helm repo update
   ```

3. **Deploy OpenLDAP**:
   Deploy OpenLDAP using the values file you generated:
   ```
   helm install openldap openldap/openldap-stack-ha -f openldap_values.yaml
   ```

4. **Verify the Deployment**:
   After deployment, verify the OpenLDAP pods are running:
   ```
   kubectl get pods
   ```



